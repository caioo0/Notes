# 第5章 维度一致性问题
---
```md
Let's fly to the moon and play among the stars.
飞向月球，星间作伴。
```

## 5.1 维度一致性浅谈

维度建模的数据仓库中，有一个概念叫Conformed Dimension，中文一般翻译为“一致性维度”。

一致性维度是Kimball的多维体系结构中的三个关键性概念之一，另两个是`总线架构（Bus Architecture）`和`一致性事实（Conformed Fact）`



在多维体系结构中，没有物理上的数据仓库，数据仓库是由物理上的数据集市组合成，是一个逻辑概念。

数据集市的建立是可以逐步完成的，多个数据集市组合在一起，成为一个数据仓库。那么如果分步建立数据集市的过程出现了问题，数据集市就会变成孤立的集市，不能组合到整个数据仓库中，而一致性维度的提出正式为了解决这个问题。

- 一致性维度的范围是总线架构中的维度，即可能会在多个数据集市中都存在的维度，这个范围的选取需要数据架构师来决定。
- 一致性维度的内容和普通维度并没有本质上区别，都是经过数据清洗和整合后的结果。
- 一致性维度建立是在多维体系结构的后台，即数据准备区。

在多维体系结构的数据仓库项目组内需要有专门的维度设计师，他的职责就是建立维度和维护维度的一致性。在后台建立好的维度同步复制到各个数据集市。

这样所有数据集市的这部分维度都是完全相同的。建立新的数据集市时，需要在后台进行一致性维度处理，根据情况来决定是否新增和修改一致性维度，然后同步复制到各个数据集市。这样不同数据集市的维度就可以保持一致。

在同一个集市内，一致性维度的意思是两个维度是有关系的，要么就是完全一样的，要么就是一个维度在数学意义上是另一个维度的子集。

例如，如果建立月维度，月维度的各种描述必须与日期维度中的完全一致，最常用的做法就是在日期维度上建立视图生成月维度。

这样月维度就可以是日期维度的子集，在后续钻取等操作时可以保持一致。如果维度表中的数据量较大，出于效率的考虑，应该建立物化视图或者实际的物理表。

这样，维度保持一致后，事实表就可以保存在各个数据集市中。虽然在物理上是独立的，但在逻辑上由一致性维度使所有的数据集市是联系在一起，随时可以进行交叉数据探索等操作，同时也就组成了数据仓库。


**一致性维度的交付步骤** 

数据整合的关键就是生成一致性维度，再通过一致性维度将来自不同数据源的事实数据合并到一起，供分析使用。通常来说，生成一致性维度有如下三个步骤：

**1.标准化（Standardizing）**

标准化的目的是使不同数据源的数据编码方式，数据格式等相同，为下一步数据匹配打下基础(数据标准化中的代码标准化过程)。

**2.匹配（Matching and Deduplication）**

数据匹配的工作有两方面，一是将不同数据源的标识同一事物的不同属性匹配到一起(例如：客户的不同产品)，使数据更完善；另一是将不同数据源的相同数据标识成重复，为下一步的筛选打下基础(例如：来源于不同数据源中重复的客户姓名)。

**3.筛选（Surviving）**

数据筛选的主要目的是选定一致性维度作为主数据（Master Data），也就是最终交付的一致性维度数据。

**维度建模要点**

选取业务处理，定义事实表的粒度，选定维度，确定事实；这四部是维度建模要点，这种方法，容易造成大量的数据烟囱，在模型管理和控制不好的情况下会造成数据与计算资源复用率低下，数据仓库数据量大量膨胀，同时存在数据模型缺乏体系性，使用数据复杂。

针对以上问题，应在于要在选取业务阶段，数据模型设计者需要具有全局和发展的视角，应该理解整体业务流程的基础上，从全局角度选取业务处理。

首先数据仓库的模型设计者应该分析源系统的实体关系模型以及业务流程，选取在整体业务流程中的关键实体作为建模的基础，建立这些实体对象的数据粒度关系，因为不同粒度的数据是不能融合的一个事实表中的。

通常可以从以下三个角度来建立事实表：

- 1.针对某个特定的行为动作，建立一个以行为活动最小单元为粒度的事实表。最小活动单元的定义，依赖于分析业务需求。比如用户的一次网页点击行为、一次网站登录行为，一次电话通话记录。这种事实表，主要用于从多个维度计，行为的发生情况，主要用于业务分布情况，绩效考核比较等方面的数据分析。

- 2.针对某个实体对象在当前时间上的状况。我们通过对这个实体对象在不同阶段存储它的快照，比如账户的余额、用户拥有的产品数等，通过这种可以统计实体对象在不同的生命周期中的关键数量指标。

- 3.针对业务活动中的重要分析和跟踪对象，统计在整个企业不同业务活动中的发生情况。比如会员，可以执行或参与多个特定的行为活动。这种事实表是以上两种事实表的一个总结和归纳。它主要用于针对我们业务中的活动对象进行跟踪和考察。


## 5.2 维度一致性类型

**1. 共享维度表**

当两个或更多维度表满足这些要求时，这些表格被称为一致的。

- 表共享相同的结构。
- 表共享相同的内容。

```md
技巧：
共享的维度表支持使用其中任意的维度属性横向钻取相关的事实表。结构和内容相同的不同维度表支持对事实表的横向钻取；完全相同的副本也是一致的。
```


当一个共享维度存在多个副本时，需要一个单独的ETL过程负责处理新的和发生改变的数据。


**2. 一致性上卷**

保持一致性并不需要维度表完全相同。如果能够满足以下条件。不相同的维度表也能够支持横向钻取过程：

- 表的维度属性是其他表的维度属性的子集。
- 公共维度属性具有相同的结构和内容。
当满足这些要求时，维度表就是一致的。可以基于任何一个公共维度属性，通过横向钻取比较相关事实表。

**3. 一致的退化维度**

**4. 重叠维度**


## 5.3 维度数据仓库

- 包含一致性设计的策略计划
- 现实的压力

## 5.4 企业信息化工厂

- 数据集市中的一致性
- 跨数据集市的一致性

## 5.5 独立型数据集市 

- 不一致性共存
- 一致性实践
- 维度改装

## 5.6 本章总结

一致性维度是成功维度设计的重要组成部分。一致性维度允许用户跨过程边界，无论是在主题区域中还是跨企业提出问题。对这些问题的回答可能时非常强大的。许多企业的关键业绩指标包含在只能以这种方式被评估的度量中。

本章为您提供了开发许多种类的一致性维度的必要知识，探寻了横向钻取的过程，提供了关于维度设计如何确保或破坏这一过程的内容。

- 当两个或更多事实表不能共享具有相同结构或内容的维度时，横向钻取就会失败。具有相同的维度可以避免出现失败，当一个维度是另外一个维度的子集时，也可能具有一致性。
通过这种经验，针对一致性的需求就可以开发。本章讨论了4种一致性开发方法：
- 表在结构和内容上都是完全相同的。此领域存在的缺点有时能被变通，但增加了在开发报表方面的复杂性开销，导致性能下降、出现不精确结果的风险。
- 当一个表的维度属性是另一个表的属性的子集时，表是一致的。表被称为上卷维度和基本维度。它们不共享公共代理键，但是公共属性必须拥有相同的结构和内容。
- 退化维度能够作为一致性的基础。此外，相应的列在结构和内容上应当始终保持一致，但是没有必要使每个事实表都共享相同的一组实例组合，因为这样做会增加违背稀疏性的可能。 
- 重叠维度也可以是一致的。一些设计者不喜欢这种一致性，因为需要多重过程以相同方式加载等价的维度列。

除了结构，一致性维度是每个包含星型模式的数据仓库的重要部分。

- 由于许多交错的关系在一张图表中容易引起混乱，因此一致性维度最好能通过矩阵被有效地描述。矩阵能够在数据集市或跨数据集市中描述一致性。
- 一致性维度是维度数据仓库结构的中心特征，作为战略性设计工作的一部分存在。这种初期工作允许单独地开展对个体的实现，确保在联机时被组装在一起。
- 在企业化数据仓库中，由于企业数据仓库的出现，规划一致性的价值减弱了。但在数据集市中一致性仍然很重要，并且跨数据集市的一致性能够帮助避免为了实现跨主题区域而构建额外数据集市的需求。
- 独立型数据集市不需要一致性。通过规划跨主题区域中已知的具有重要性的少数关键维度的一致性，相关风险能被部分缓解，但此过程是比较复杂的。



