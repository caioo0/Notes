# **第12章 并发编程**

如果逻辑控制流在时间上重叠，那么就称它们是**并发**的。**注意：核心是在时间上重叠。**

操作系统内核运行多个应用程序采用了并发机制，但并发不止用于内核，也用于应用程序中。应用级并发的一些应用场合：

1. 访问慢速 I/O 设备。当一个用户等待来自慢速 I/O 设备（比如磁盘）的数据到达时，内核会运行其他进程。
2. 与人交互。每次用户请求某种操作时（比如通过点击鼠标），一个独立的并发逻辑流被创建来执行这个操作。
3. 通过推迟工作以降低延迟。
4. 服务多个网络客户端。一个并发服务器为每个客户端创建一个单独的逻辑流。
5. 在多核机器上进行并行计算。被划分称并发流的应用程序通常在多个机器上比单处理器机器上快很多，因为这些流会并行执行，而不是交错执行。

使用应用级并发的应用程序称为**并发程序**。OS 提供了**三种基本的构造并发程序的方法：**

1. **进程。**在这种形式下，每个逻辑控制流都是一个进程，**由内核来调度和维护**。因为进程**有独立的虚拟地址空间**，想要和其他流通信，控制流必须使用显式的进程间通信（IPC）机制。
2. **I/O 多路复用。**在这种形式下，应用程序在一个进程的上下文中显式地调用它们自己的逻辑流。逻辑流被模型化为状态机，数据到达文件描述符后，主程序显式地从一个状态转换到另一个状态。因为程序是一个单独的进程，所以所有的流都共享同一个地址空间。
3. **线程。**线程是运行在一个单一进程上下文中的逻辑流，由内核进行调度。线程像进程流一样由内核进行调度，像 I/O 多路复用一样共享同一个虚拟地址空间。

**12.1 基于进程的并发编程**

构造并发程序最简单的方法就是用进程，使用 fork, exec, waitpid 等函数。

一个构造并发服务器的自然方法就是在父进程中接受客户端连接请求，然后创建一个新的子进程来为每个客户端提供服务。

​    ![0](https://note.youdao.com/yws/public/resource/2c486be56b632f5557328e40581c5e2b/xmlnote/C19D0AE0FB1A4734B78E49844F4513E6/41785)

上图中，服务器正在监听一个**监听描述符**（listenfd3）上的连接请求。然后服务器接受了客户端 1 的连接请求，返回给客户端 1 一个**已连接描述符**（connfd4）。这之后服务器要进行如下操作：

1. 派生一个子进程，这个子进程获得服务器**描述符表**的完整副本。
2. 子进程关闭它的副本中的监听描述符 listenfd3。
3. **父进程关闭它的已连接描述符 connfd4 的副本**。

因为**父、子进程中的已连接描述符 connfd4 指向同一个文件表表项**，所以父进程必须关闭它的 connfd 的副本，否则将永远不会释放 connfd4 的文件表条目，导致内存泄漏，进而耗光内存，系统崩溃。

**12.1.1 基于进程的并发服务器**

​                '一个基于进程的并发 echo 服务器' #include "csapp.h" void echo(int connfd); void sigchld_handler(int sig) {    while(waitpid(-1, 0, WNOHANG) > 0) ;    return; }              

**12.1.2 进程的优劣**

**12.2 基于I/O多路复用的并发编程**

**12.2.1 基于I/O多路复用的并发事件驱动服务器**

**12.2.2 I/O多路复用技术的优劣**

**12.3 基于线程的并发编程**

**12.3.1 线程执行模型**

**12.3.2 Posix程**

**12.3.3 创建线程**

**12.3.4 终止线程**

**12.3.5 回收已终止线程的资源**

**12.3.6 分离线程**

**12.3.7 初始化线程**

**12.4 多线程程序中的共享变量**

**12.4.1 线程内存模型**

**12.4.2 将变量映射到内存**

**12.4.3 共享变量**

**12.5 用信号量同步线程**

**12.5.1 进度**

**12.5.2 信号量**

**12.5.3 使用信号量来实现互斥**

**12.5.4 利用信号量来调度共享资源**

**12.5.5 综合:基于预线程化的并发服务器**

**12.6 使用线程提高并行性**

**12.7 其他并发问题**

**12.7.1 线程安全**

**12.7.2 可重入性**

**12.7.3 在线程化的程序中使用已存在的库函数**

**12.7.4 竞争**

**12.7.5 死锁**